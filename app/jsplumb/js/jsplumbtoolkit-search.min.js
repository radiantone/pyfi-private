(function(){function r(e,t){return t?e:e.toLowerCase()}function s(e){for(var t=e.replace(/^\s\s*/,""),n=/\s/,o=t.length;n.test(t.charAt(--o)););return t.slice(0,o+1)}function t(e){for(var t=(e=""+e).split(/\s/),n=[],o=[],i=0;i<t.length;i++){var d=s(t[i].replace(/[^\w]*/,""));0<d.length&&(n.push({token:d,context:""}),o.unshift(d),o.splice(3),1<o.length&&(o.reverse(),n.push({token:o.join(" "),context:""}),o.reverse()))}for(o.pop();1<o.length;)o.reverse(),n.push({token:o.join(" "),context:""}),o.reverse(),o.pop();return n}function n(e){return[{token:s(e),context:e}]}function o(e,t){return e.score>t.score?-1:1}function i(e){return e.id}var d=(e.prototype._makeNode=function(e){return{index:this._nodeIdx++,children:{},documentIds:{},key:e}},e.prototype._storeNodeReferenceForDocument=function(e,t,n){var o=this._nodeMap[e];o||(o={},this._nodeMap[e]=o),o[t.index]=t},e.prototype._addToken=function(e,t,r){var s=this,u=function(e,t,n,o){if(t!==n.length){var i=n[t],d=e.children[i];d||(d=s._makeNode(i),e.children[i]=d),d.documentIds[o]=d.documentIds[o]||[],d.documentIds[o].push(n),s._storeNodeReferenceForDocument(o,d,r),u(d,t+1,n,o)}};u(this.root,0,e,t)},e.prototype.removeExclusions=function(e){var t={};for(var n in e)-1===this.exclusions.indexOf(n)&&(t[n]=e[n]);return t},e.prototype.add=function(e){function t(o){var e=d.removeExclusions(o);!function(d,r,s){if(0!==d.length){var u=function(e,t){var n=e+Math.floor((t-e)/2),o=d[n],i=s(o,r);if(0!==i)if(-1===i){if(n===d.length-1)return void d.push(r);if(s(d[n+1],r)!==i)return void d.splice(n+1,0,r);u(n+1,t)}else{if(0===n)return void d.unshift(r);if(s(d[n-1],r)!==i)return void d.splice(n,0,r);u(e,e+Math.floor((t-e)/2))}else d.splice(n,0,r)};u(0,d.length-1)}else d.push(r)}(d._documentList,{document:e,score:1},d.sorter);var i=d.idFunction(o),t={fields:function(e){for(var t=0;t<d.fields.length;t++){var n=o[d.fields[t]];jsPlumbUtil.isString(n)&&e(n)}},document:function(e){for(var t in o)if("id"!==t){var n=o[t];jsPlumbUtil.isString(n)&&e(n)}}};d._documentMap.set(i,e),t[d.fields?"fields":"document"](function(e){if(e)for(var t=d.tokenizer(e),n=0;n<t.length;n++)d._addToken(r(t[n].token,d.caseSensitive),i,t[n].context)}),d._documentCount++}var d=this;if(e.constructor===Array)for(var n=0;n<e.length;n++)t(e[n]);else t(e)},e.prototype.addAll=function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];for(var n=0;n<e.length;n++)this.add(e[n])},e.prototype.reindex=function(e){this.remove(e),this.add(e)},e.prototype.remove=function(e){var t,n=this.idFunction(e),o=this._nodeMap[n];if(o)for(t in o)delete o[t].documentIds[n];var i=-1;for(t=0;t<this._documentList.length;t++)if(this.idFunction(this._documentList[t].document)===n){i=t;break}-1!==i&&(this._documentList.splice(i,1),this._documentCount=this._documentList.length),this._documentMap.delete(n)},e.prototype.clear=function(){this._documentMap.clear(),this._nodeMap={},this._nodeIdx=0,this._documentList.length=0,this._documentCount=0,this.root=this._makeNode()},e.prototype.getDocumentCount=function(){return this._documentCount},e.prototype.getDocumentList=function(){return this._documentList},e.prototype.getDocument=function(e){return this._documentMap.get(e)},e.prototype.search=function(e,t){for(var n=this.searchTokenizer(e),h={},o=[],p={},f={},l=function(e,t,n){if(t!==n.length){var o,i,d,r,s=n[t];e.children[s]&&l(e.children[s],t+1,n)}else for(var u in e.documentIds)if(e.documentIds.hasOwnProperty(u))for(var c=e.documentIds[u],a=0;a<c.length;a++)o=u,i=n,d=c[a],r=void 0,(r=h[o])||(r={},h[o]=r,p[o]=0,f[o]=[]),f[o].push(d),r[i]||(r[i]=!0,p[o]++)},i=0;i<n.length;i++)l(this.root,0,r(n[i].token,this.caseSensitive));for(var d in h)o.unshift({document:this._documentMap.get(d),score:p[d],contexts:f[d]});return o.sort(this.sorter),o.slice(0,null==t?this.limit:t)},e);function e(e){this._nodeIdx=0,this._documentMap=new Map,this._documentList=[],this._documentCount=0,this._nodeMap={},e=e||{},this.fields=e.fields,this.root=this._makeNode(),this.tokenizer=e.tokenizer||t,this.searchTokenizer=e.searchTokenizer||n,this.limit=e.limit||10,this.exclusions=e.exclusions||[],this.caseSensitive=!0===e.caseSensitive,this.includeContext=!0===e.includeContext,this.idFunction=e.idFunction||i,this.sorter=e.sorter||o}var u=(c.prototype._indexNode=function(e){var t=this;this.nodeIndex.add(e.data),e.getPorts().forEach(function(e){return t.portIndex.add(e.data)})},c.prototype._indexGroup=function(e){this.groupIndex.add(e.data)},c.prototype._indexEdge=function(e){jsPlumb.extend(e.data||{},{id:e.getId()}),this.edgeIndex.add(e.data)},c.prototype.search=function(e){var t=this,n=this.nodeIndex.search(e).map(function(e){return t.instance.getNode(e.document.id)}),o=this.portIndex.search(e).map(function(e){return t.instance.getPort(e.document.id)});return{nodes:n,groups:this.groupIndex.search(e).map(function(e){return t.instance.getGroup(e.document.id)}),edges:this.edgeIndex.search(e).map(function(e){return t.instance.getEdge(e.document.id)}),ports:o}},c);function c(e,t){var o=this;this.instance=e,this.nodeIndex=new d(t),this.groupIndex=new d(t),this.edgeIndex=new d(t),this.portIndex=new d(t),e.bind("nodeAdded",function(e){o._indexNode(e.node)}),e.bind("nodeRemoved",function(e){o.nodeIndex.remove(e.node.data),e.node.getPorts().forEach(function(e){return o.portIndex.remove(e.data)})}),e.bind("nodeUpdated",function(e){o.nodeIndex.remove(e.node.data),o.nodeIndex.add(e.node.data)}),e.bind("groupAdded",function(e){o._indexGroup(e.group)}),e.bind("groupRemoved",function(e){o.groupIndex.remove(e.group.data)}),e.bind("groupUpdated",function(e){o.groupIndex.remove(e.group.data),o.groupIndex.add(e.group.data)}),e.bind("edgeAdded",function(e){o._indexEdge(e.edge)}),e.bind("edgeRemoved",function(e){o.edgeIndex.remove({id:e.edge.getId()})}),e.bind("edgeUpdated",function(e){var t=jsPlumb.extend(e.originalData||{},{id:e.edge.getId()});o.edgeIndex.remove(t);var n=jsPlumb.extend(e.edge.data||{},{id:e.edge.getId()});o.edgeIndex.add(n)}),e.bind("portAdded",function(e){o.portIndex.add(e.port.data)}),e.bind("portRemoved",function(e){o.portIndex.remove(e.port.data)}),e.bind("portUpdated",function(e){o.portIndex.remove(e.port.data),o.portIndex.add(e.port.data)}),e.bind("graphCleared",function(){o.nodeIndex.clear(),o.groupIndex.clear(),o.edgeIndex.clear(),o.portIndex.clear()}),this.instance.eachNode(function(e,t){o._indexNode(t)}),this.instance.eachGroup(function(e,t){o._indexGroup(t)}),this.instance.eachEdge(function(e,t){o._indexEdge(t)})}this.jsPlumbToolkitSearch=u,"undefined"!=typeof exports&&(exports.jsPlumbToolkitSearch=u)}).call("undefined"!=typeof window?window:this);