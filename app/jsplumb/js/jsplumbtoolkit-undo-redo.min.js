(function(){var e,t=this&&this.__extends||(e=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,o){t.__proto__=o}||function(t,o){for(var i in o)o.hasOwnProperty(i)&&(t[i]=o[i])},function(t,o){function i(){this.constructor=t}e(t,o),t.prototype=null===o?Object.create(o):(i.prototype=o.prototype,new i)}),n=(o.prototype.generateSourceId=function(){return null==this.sourcePort?this.source:this.source+this.toolkit.getGraph().getPortSeparator()+this.sourcePort},o.prototype.generateTargetId=function(){return null==this.targetPort?this.target:this.target+this.toolkit.getGraph().getPortSeparator()+this.targetPort},o.prototype._add=function(){var t={source:this.generateSourceId(),target:this.generateTargetId(),data:this.obj.data};null!=this.geometry&&(t.geometry=this.geometry);var o=this.toolkit.connect(t);this.manager.edgeChange(this.edgeId,o)},o.prototype._remove=function(){this.toolkit.removeEdge(this.obj)},o.prototype.edgeChange=function(t){this.obj=t,this.edgeId=this.obj.getId()},o);function o(t,o,i){this.obj=t,this.toolkit=o,this.manager=i,this.source=t.source.getFullId(),this.target=t.target.getFullId(),"Port"===t.source.objectType&&(this.sourcePort=t.source.id,this.source=t.source.getNode().getFullId()),"Port"===t.target.objectType&&(this.targetPort=t.target.id,this.target=t.target.getNode().getFullId()),this.edgeId=t.getId(),this.geometry=t.geometry}var i,r=(t(s,i=n),s.prototype.undo=function(){this._remove()},s.prototype.redo=function(){this._add()},s);function s(){return null!==i&&i.apply(this,arguments)||this}var d,a=(t(u,d=n),u.prototype.undo=function(){this._add()},u.prototype.redo=function(){this._remove()},u);function u(){return null!==d&&d.apply(this,arguments)||this}var h=(c.prototype._apply=function(t){var o=this.surface.getRenderedConnection(this.edge.getId());null!=t?o.getConnector().importGeometry(t,o):o.getConnector().clearEdits(),o.repaint()},c.prototype.undo=function(){this._apply(this.originalGeometry)},c.prototype.redo=function(){this._apply(this.geometry)},c);function c(t,o,i,e){this.surface=t,this.edge=o,this.originalGeometry=i,this.geometry=e}var p=(l.prototype._add=function(){"Node"===this.obj.objectType?this.obj=this.toolkit.addNode(this.obj.data):"Group"===this.obj.objectType&&(this.obj=this.toolkit.addGroup(this.obj.data))},l.prototype._remove=function(){this.toolkit.remove(this.obj)},l.prototype.getTerminusId=function(){return this.obj.getFullId()},l);function l(t,o){this.obj=t,this.toolkit=o}var f,g=(t(m,f=p),m.prototype.undo=function(){this._remove()},m.prototype.redo=function(){this._add()},m);function m(){return null!==f&&f.apply(this,arguments)||this}var y,k=(t(b,y=p),b.prototype.undo=function(){this._add()},b.prototype.redo=function(){this._remove()},b.prototype.isConnectedTo=function(t){var o=this.getTerminusId();return t.source===o||t.target===o},b);function b(){return null!==y&&y.apply(this,arguments)||this}var v=(_.prototype._add=function(){this.toolkit.addPort(this.parent,this.obj.data)},_.prototype._remove=function(){this.toolkit.removePort(this.parent,this.obj.id)},_.prototype.getTerminusId=function(){return this.obj.getFullId()},_);function _(t,o,i){this.obj=t,this.parent=o,this.toolkit=i}var j,w=(t(S,j=v),S.prototype.undo=function(){this._remove()},S.prototype.redo=function(){this._add()},S);function S(){return null!==j&&j.apply(this,arguments)||this}var T,P=(t(I,T=v),I.prototype.undo=function(){this._add()},I.prototype.redo=function(){this._remove()},I.prototype.isConnectedTo=function(t){var o=this.getTerminusId();return t.generateSourceId()===o||t.generateTargetId()===o},I);function I(){return null!==T&&T.apply(this,arguments)||this}var C=(E.prototype._getMethod=function(){return"update"+this.obj.objectType},E.prototype.undo=function(){this.toolkit[this._getMethod()](this.obj,this.originalData)},E.prototype.redo=function(){this.toolkit[this._getMethod()](this.obj,this.newData)},E);function E(t,o,i){this.obj=t,this.toolkit=i,this.newData=jsPlumb.extend({},t.data),this.originalData=jsPlumb.extend({},o)}var G=(U.prototype.redo=function(){this.surface.setPosition(this.obj,this.pos[0],this.pos[1])},U.prototype.undo=function(){this.surface.setPosition(this.obj,this.originalPosition[0],this.originalPosition[1])},U);function U(t,o,i,e){this.obj=t,this.originalPosition=o,this.pos=i,this.surface=e}function x(t,o,i){this.node=t,this.group=o,this.toolkit=i}var A,R=(t(N,A=x),N.prototype.redo=function(){this.toolkit.addToGroup(this.node,this.group)},N.prototype.undo=function(){this.toolkit.removeFromGroup(this.node)},N);function N(){return null!==A&&A.apply(this,arguments)||this}var D,F=(t(M,D=x),M.prototype.redo=function(){this.toolkit.removeFromGroup(this.node)},M.prototype.undo=function(){this.toolkit.addToGroup(this.node,this.group)},M);function M(){return null!==D&&D.apply(this,arguments)||this}var z=(O.prototype.addAction=function(t){this.actions.push(t)},O.prototype.undo=function(){this.actions.slice().reverse().forEach(function(t){return t.undo()})},O.prototype.redo=function(){this.actions.forEach(function(t){return t.redo()})},O.prototype.edgeChange=function(o,i){this.actions.forEach(function(t){t instanceof n&&t.edgeId===o&&t.edgeChange(i)})},O);function O(t){this.actions=t,null==this.actions&&(this.actions=[])}var L=(Y.prototype._possiblyCompound=function(t){if(this.compound){for(var o=[],i=this.undoStack.length-1,e=t;-1<i;){var n=this.undoStack[i];if(!(n instanceof a&&t.isConnectedTo(n)))break;o.unshift(n),i--}if(0<o.length){o.push(t);var r=new z(o);this.undoStack.splice(i+1),e=r}else e=t;return e}return t},Y.prototype._addTerminusRemoveAction=function(t){this.command(this._possiblyCompound(new k(t,this.toolkit)))},Y.prototype._objectNotEmpty=function(t){for(var o in t)if(t.hasOwnProperty(o))return!0;return!1},Y.prototype._bindListeners=function(){var o=this;this.toolkit.bind("dataLoadStart",function(){o.clear(),o.suspend=!0}),this.toolkit.bind("dataLoadEnd",function(){o.suspend=!1}),this.toolkit.bind("graphCleared",function(){o.clear()}),this.toolkit.bind("nodeAdded",function(t){o.command(new g(t.node,o.toolkit))}),this.toolkit.bind("nodeRemoved",function(t){o._addTerminusRemoveAction(t.node)}),this.toolkit.bind("nodeUpdated",function(t){o._objectNotEmpty(t.updates)&&o.command(new C(t.node,t.originalData,o.toolkit))}),this.toolkit.bind("groupAdded",function(t){o.command(new g(t.group,o.toolkit))}),this.toolkit.bind("groupRemoved",function(t){o._addTerminusRemoveAction(t.group)}),this.toolkit.bind("groupUpdated",function(t){o._objectNotEmpty(t.updates)&&o.command(new C(t.group,t.originalData,o.toolkit))}),this.toolkit.bind("edgeAdded",function(t){o.command(new r(t.edge,o.toolkit,o))}),this.toolkit.bind("edgeRemoved",function(t){o.command(new a(t.edge,o.toolkit,o))}),this.toolkit.bind("edgeUpdated",function(t){o._objectNotEmpty(t.updates)&&o.command(new C(t.edge,t.originalData,o.toolkit))}),this.toolkit.bind("edgePathEdited",function(t){o.command(new h(o.surface,t.edge,t.originalGeometry,t.geometry))}),this.toolkit.bind("portAdded",function(t){o.command(new w(t.port,t.node,o.toolkit))}),this.toolkit.bind("portRemoved",function(t){o.command(o._possiblyCompound(new P(t.port,t.node,o.toolkit)))}),this.toolkit.bind("portUpdated",function(t){o._objectNotEmpty(t.updates)&&o.command(new C(t.port,t.originalData,o.toolkit))}),null!=this.surface&&this.surface.bind("nodeMoveEnd",function(t){null!=t.originalPosition&&o.command(new G(t.node||t.group,t.originalPosition,t.pos,o.surface))}),this.toolkit.bind("group:addMember",function(t){o.command(new R(t.node,t.group,o.toolkit))}),this.toolkit.bind("group:removeMember",function(t){o.command(new F(t.node,t.group,o.toolkit))})},Y.prototype._fireUpdate=function(){this.onChange&&this.onChange(this,this.undoStack.length,this.redoStack.length)},Y.prototype.command=function(t){this.suspend||(null!=this.currentTransaction?this.currentTransaction.addAction(t):(this.undoStack.push(t),this.undoStack.length>this.maximumSize&&this.undoStack.splice(this.undoStack.length-this.maximumSize-1,this.undoStack.length-this.maximumSize),this.redoStack.length=0,this._fireUpdate()))},Y.prototype.edgeChange=function(o,i){function t(t){t.forEach(function(t){t instanceof n&&t.edgeId===o?t.edgeChange(i):t instanceof z&&t.edgeChange(o,i)})}t(this.undoStack),t(this.redoStack)},Y.prototype.undo=function(){var t=this.undoStack.pop();t&&(this.suspend=!0,this.redoStack.push(t),t.undo(),this.suspend=!1,this._fireUpdate())},Y.prototype.redo=function(){var t=this.redoStack.pop();t&&(this.suspend=!0,this.undoStack.push(t),t.redo(),this.suspend=!1,this._fireUpdate())},Y.prototype.clear=function(){this.undoStack.length=0,this.redoStack.length=0,this.currentTransaction=null,this._fireUpdate()},Y.prototype.transaction=function(t){if(null!=this.currentTransaction)throw new Error("Cannot start a new transaction while one is active");this.currentTransaction=new z,t();var o=this.currentTransaction;this.currentTransaction=null,this.command(o)},Y);function Y(t){if(this.toolkit=t.toolkit,this.surface=t.surface,null==this.surface&&null==this.toolkit)throw new Error("You must provide at least `toolkit` for the Undo/redo manager.");null!=this.surface&&(this.toolkit=this.surface.getToolkit()),this.suspend=!1,this.undoStack=[],this.redoStack=[],this.compound=!0===t.compound,this.maximumSize=t.maximumSize||50,this.onChange=t.onChange,this._bindListeners()}this.jsPlumbToolkitUndoRedo=L,"undefined"!=typeof exports&&(exports.jsPlumbToolkitUndoRedo=L)}).call("undefined"!=typeof window?window:this);