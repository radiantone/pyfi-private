version: '3.9'

services:
  clientsocket:
    build:
      context: socket
      dockerfile: Dockerfile
    image: pyfi/clientsocket:latest
    container_name: clientsocket
    ports:
      - '3003:3003'

  postgresdb:
    container_name: postgresdb
    image: postgres:latest
    hostname: postgresdb
    restart: always
    environment:
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: pyfi101
      POSTGRES_DB: pyfi
      PGDATA: /var/lib/postgresql/data/pgdata
    ports:
      - "5434:5432"
    volumes:
      - ./conf/pg_hba.conf:/var/lib/postgresql/data/pg_hba.conf
      - ./pg-data:/var/lib/postgresql/data
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 5s
      timeout: 5s
      retries: 6

  nginx:
    image: 013035288901.dkr.ecr.us-east-1.amazonaws.com/nginx:latest
    container_name: nginx
    volumes:
      - ./logs:/etc/nginx/logs
    links:
      - rabbitmq
      - rabbitmq2
    ports:
      - '80:80'
      - '443:443'
    depends_on:
      - rabbitmq2
      - api

  api:
    container_name: api
    image: pyfi/api:latest
    environment:
      - "EVENTS=events"
      - "CB_KEY=test_cd3cu6vRcuyFScdCW8W8Y3QU1HmrVZ7AaXEm"
      - "CB_SITE=elasticcode-test"
    ports:
      - '8000:8003'
    depends_on:
      - redis
      - mongodb
      - postgresdb

  rabbitmq:
    container_name: rabbitmq
    hostname: rabbitmq
    image: 013035288901.dkr.ecr.us-east-1.amazonaws.com/rabbitmq:management
    restart: always
    volumes:
      - ./data:/var/lib/rabbitmq/mnesia/
    environment:
      - RABBITMQ_ERLANG_COOKIE=cluster_cookie
      - CLUSTERED=true
    ports:
      - '5671:5671'
      - '5672:5672'
      - '15672:15672'
      - '4369:4369'

  rabbitmq2:
    container_name: rabbitmq2
    hostname: rabbitmq2
    image: rabbitmq:management
    volumes:
      - ./conf/enabled_plugins:/etc/rabbitmq/enabled_plugins
      - ./conf/rabbit-cluster.sh:/tmp/rabbit-cluster.sh
    links:
      - rabbitmq
    depends_on:
      - rabbitmq
    environment:
      - RABBITMQ_ERLANG_COOKIE=cluster_cookie
      - CLUSTERED=true
      - CLUSTER_WITH=rabbitmq
      - RAM_NODE=true
    ports:
      - "5673:5672"
      - "15673:15672"

  redis:
    container_name: redis
    hostname: redis
    image: redislabs/redismod
    restart: always
    ports:
      - '6379:6379'

  mongodb:
      image: mongo:latest
      container_name: mongodb
      environment:
        MONGO_INITDB_ROOT_USERNAME: root
        MONGO_INITDB_ROOT_PASSWORD: rootpassword
      ports:
        - '27017:27017'
      volumes:
        - mongodb_data_container:/data/db

volumes:
  mongodb_data_container:
  pgdata:
  influxdb_data:
    driver: local